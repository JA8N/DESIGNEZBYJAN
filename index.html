// ========================================
// CONFIGURATION
// ========================================
const CONFIG = {
  animationDuration: 800,
  debounceDelay: 10,
  observerThreshold: 0.1,
  observerRootMargin: '0px 0px -100px 0px'
};

// ========================================
// UTILITY FUNCTIONS
// ========================================
const debounce = (func, wait) => {
  let timeout;
  return function executedFunction(...args) {
    clearTimeout(timeout);
    timeout = setTimeout(() => func.apply(this, args), wait);
  };
};

const getElement = (selector) => document.querySelector(selector);
const getElements = (selector) => document.querySelectorAll(selector);

// ========================================
// SMOOTH SCROLL
// ========================================
const initSmoothScroll = () => {
  getElements('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', (e) => {
      e.preventDefault();
      const target = getElement(anchor.getAttribute('href'));
      if (target) {
        target.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start'
        });
      }
    });
  });
};

// ========================================
// LIGHTBOX
// ========================================
class Lightbox {
  constructor() {
    this.lightbox = getElement('#lightbox');
    this.lightboxImg = this.lightbox.querySelector('img');
    this.lightboxInfo = this.lightbox.querySelector('.lightbox-info');
    this.lightboxClose = this.lightbox.querySelector('.lightbox-close');
    this.init();
  }

  init() {
    // Reference cards
    getElements('.float-card').forEach((card, index) => {
      card.addEventListener('click', () => this.open({
        img: card.querySelector('img'),
        title: `Reference Image ${index + 1}`,
        description: "Original inspiration for design"
      }));
    });

    // Result cards
    getElements('.result-card').forEach(card => {
      card.addEventListener('click', () => this.open({
        img: card.querySelector('.card-image img'),
        title: card.querySelector('.card-caption h4').textContent,
        description: card.querySelector('.card-caption p').textContent
      }));
    });

    // Close events
    this.lightboxClose.addEventListener('click', () => this.close());
    this.lightbox.addEventListener('click', (e) => {
      if (e.target === this.lightbox) this.close();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && this.lightbox.classList.contains('show')) {
        this.close();
      }
    });
  }

  open({ img, title, description }) {
    this.lightboxImg.src = img.src;
    this.lightboxImg.alt = img.alt;
    this.lightboxInfo.innerHTML = `
      <h3 style="color: var(--text-primary); font-size: 1.5rem; margin-bottom: 0.5rem;">${title}</h3>
      <p style="color: var(--text-secondary);">${description}</p>
    `;
    this.lightbox.classList.add('show');
    document.body.style.overflow = 'hidden';
  }

  close() {
    this.lightbox.classList.remove('show');
    document.body.style.overflow = '';
  }
}

// ========================================
// INTERSECTION OBSERVER (Scroll Animations)
// ========================================
const initScrollAnimations = () => {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.style.animation = `fadeInUp ${CONFIG.animationDuration}ms ease-out forwards`;
        observer.unobserve(entry.target);
      }
    });
  }, {
    threshold: CONFIG.observerThreshold,
    rootMargin: CONFIG.observerRootMargin
  });

  // Observe elements
  const elementsToObserve = [
    ...getElements('.glass-box'),
    ...getElements('.result-card'),
    ...getElements('.about'),
    ...getElements('.contact')
  ];

  elementsToObserve.forEach(el => observer.observe(el));
};

// ========================================
// PARALLAX HERO
// ========================================
const initParallaxHero = () => {
  const hero = getElement('.hero-content');
  if (!hero) return;

  const handleScroll = () => {
    const scrolled = window.pageYOffset;
    if (scrolled < window.innerHeight) {
      hero.style.transform = `translateY(${scrolled * 0.5}px)`;
      hero.style.opacity = 1 - (scrolled / window.innerHeight);
    }
  };

  window.addEventListener('scroll', debounce(handleScroll, CONFIG.debounceDelay));
};

// ========================================
// LAZY LOADING
// ========================================
const initLazyLoading = () => {
  if ('loading' in HTMLImageElement.prototype) {
    // Native lazy loading supported
    getElements('img[loading="lazy"]').forEach(img => {
      if (img.dataset.src) {
        img.src = img.dataset.src;
      }
    });
  } else {
    // Fallback for older browsers
    const script = document.createElement('script');
    script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.3.2/lazysizes.min.js';
    document.body.appendChild(script);
  }
};

// ========================================
// PAGE LOAD ANIMATION
// ========================================
const initPageLoadAnimation = () => {
  document.body.style.opacity = '0';
  setTimeout(() => {
    document.body.style.transition = 'opacity 0.5s ease';
    document.body.style.opacity = '1';
  }, 100);
};

// ========================================
// KONAMI CODE EASTER EGG
// ========================================
const initKonamiCode = () => {
  let konamiCode = [];
  const konamiPattern = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];

  document.addEventListener('keydown', (e) => {
    konamiCode.push(e.key);
    konamiCode = konamiCode.slice(-10);
    
    if (konamiCode.join('') === konamiPattern.join('')) {
      document.body.style.animation = 'rainbow 2s infinite';
      setTimeout(() => {
        document.body.style.animation = '';
      }, 5000);
    }
  });

  // Add rainbow animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes rainbow {
      0% { filter: hue-rotate(0deg); }
      100% { filter: hue-rotate(360deg); }
    }
  `;
  document.head.appendChild(style);
};

// ========================================
// PERFORMANCE MONITORING (Optional)
// ========================================
const logPerformance = () => {
  if ('performance' in window) {
    window.addEventListener('load', () => {
      const perfData = performance.timing;
      const pageLoadTime = perfData.loadEventEnd - perfData.navigationStart;
      console.log(`ðŸŽ¨ Roblox Design Studio loaded in ${pageLoadTime}ms`);
    });
  }
};

// ========================================
// ERROR HANDLING
// ========================================
const initErrorHandling = () => {
  window.addEventListener('error', (e) => {
    console.error('Portfolio error:', e.message);
  });

  // Handle image loading errors
  getElements('img').forEach(img => {
    img.addEventListener('error', function() {
      this.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)';
      this.alt = 'Image failed to load';
    });
  });
};

// ========================================
// INITIALIZE EVERYTHING
// ========================================
const init = () => {
  console.log('ðŸŽ¨ Initializing Roblox Design Studio...');
  
  // Core features
  initSmoothScroll();
  new Lightbox();
  initScrollAnimations();
  initParallaxHero();
  initLazyLoading();
  initPageLoadAnimation();
  
  // Easter eggs & extras
  initKonamiCode();
  
  // Error handling
  initErrorHandling();
  
  // Performance monitoring
  logPerformance();
  
  console.log('âœ… Portfolio initialized successfully!');
};

// Start when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// ========================================
// EXPORTS (for potential future modules)
// ========================================
window.PortfolioApp = {
  config: CONFIG,
  debounce,
  getElement,
  getElements
};
